# テスト仕様書

## 1. テスト概要

### 1.1 目的
掲示板アプリケーションの品質保証のため、自動テストを実装し、機能の正常動作を検証する。

### 1.2 テスト戦略
| テストレベル | ツール | カバレッジ目標 | 実行タイミング |
|-------------|--------|---------------|---------------|
| 単体テスト | Jest | 80%以上 | コミット前、CI/CD |
| E2Eテスト | Playwright | 主要シナリオ100% | プルリクエスト、リリース前 |

### 1.3 テストディレクトリ構造
```
my-board-app/
├── __tests__/              # 単体テスト
│   ├── components/         # コンポーネントテスト
│   │   ├── PostForm.test.tsx
│   │   └── PostItem.test.tsx
│   ├── lib/               # ライブラリテスト
│   │   └── mongodb.test.ts
│   └── api/               # APIテスト
│       └── posts.test.ts
├── e2e/                   # E2Eテスト
│   ├── board.spec.ts      # 掲示板機能テスト
│   └── mobile.spec.ts     # モバイル対応テスト
├── jest.config.js         # Jest設定
├── jest.setup.js          # Jestセットアップ
└── playwright.config.ts   # Playwright設定
```

## 2. 単体テスト仕様

### 2.1 コンポーネントテスト

#### PostForm.test.tsx
| テストケース | 説明 | 期待結果 |
|-------------|------|----------|
| フォームレンダリング | フォーム要素が正しく表示される | タイトル、投稿者名、内容、投稿ボタンが存在 |
| 空フォーム送信 | 空のフォームを送信 | エラーアラート表示、APIコール無し |
| 文字数超過 | 140文字超の内容を入力 | エラーアラート表示、赤色の文字カウンター |
| 正常投稿 | 有効なデータで投稿 | API呼び出し、onPostCreatedコールバック実行 |
| 投稿中の状態 | 投稿処理中のUI | ボタン無効化、「投稿中...」表示、スピナー表示 |
| 文字数カウンター | 入力に応じた文字数表示 | (現在文字数/140)形式で表示 |
| 文字数超過時の表示 | 140文字超過時のスタイル | 文字カウンターが赤色(text-red-500) |

#### PostItem.test.tsx
| テストケース | 説明 | 期待結果 |
|-------------|------|----------|
| 投稿表示 | 投稿データの表示 | タイトル、投稿者、内容、編集・削除ボタン表示 |
| 長文省略 | 200文字超の内容 | 200文字で切り取り、「続きを読む」リンク表示 |
| 全文表示切替 | 続きを読むクリック | 全文表示、「折りたたむ」リンクに変更 |
| 編集モード | 編集ボタンクリック | 編集フォーム表示、保存・キャンセルボタン |
| 削除キャンセル | 削除確認でキャンセル | 削除処理実行されない |
| 削除実行 | 削除確認でOK | DELETE API呼び出し、onDeletedコールバック |
| 削除エラー | 削除失敗時 | エラーアラート表示 |
| 日付フォーマット | 作成日時の表示 | 日本語フォーマット（YYYY年MM月DD日 HH:mm） |

### 2.2 ライブラリテスト

#### mongodb.test.ts
| テストケース | 説明 | 期待結果 |
|-------------|------|----------|
| 環境変数未設定 | MONGODB_URI未設定 | エラーをスロー |
| 接続済み確認 | 既に接続されている場合 | 再接続しない |
| 正常接続 | 新規接続 | 接続成功ログ出力 |
| 接続エラー | 接続失敗 | エラーハンドリング、ログ出力 |
| 資格情報マスク | パスワード含むURI | ログでパスワードがマスクされる |

### 2.3 APIテスト

#### posts.test.ts
| テストケース | 説明 | 期待結果 |
|-------------|------|----------|
| POST: 新規作成 | 正常な投稿作成 | 201ステータス、作成データ返却 |
| POST: 必須フィールド欠落 | タイトルなし | 400エラー、エラーメッセージ |
| POST: モックDB使用 | MongoDB接続失敗 | 201ステータス、mock:true |
| GET: 一覧取得 | 投稿一覧取得 | 200ステータス、投稿配列 |
| GET: 空リスト | 投稿0件 | 200ステータス、空配列 |
| GET: モックDB使用 | MongoDB接続失敗 | 200ステータス、mock:true、警告メッセージ |

## 3. E2Eテスト仕様

### 3.1 メイン機能テスト（board.spec.ts）

| シナリオ | テスト内容 | 検証項目 |
|----------|-----------|----------|
| ホームページ表示 | 初期画面の確認 | タイトル、ヘッダー、フォーム要素 |
| 新規投稿作成 | 投稿の作成フロー | フォーム入力→送信→表示確認 |
| 空フォーム送信 | バリデーション確認 | エラーダイアログ表示 |
| 文字数制限 | 140文字超過 | 文字カウンター赤色、エラーダイアログ |
| 投稿編集 | 編集フロー | 編集開始→内容変更→保存→表示確認 |
| 投稿削除 | 削除フロー | 削除確認→実行→非表示確認 |
| 長文省略表示 | 長い投稿の表示 | 省略表示と展開機能 |
| 編集キャンセル | 編集の取り消し | 変更破棄、元の内容表示 |
| 投稿0件表示 | 空の状態 | 「まだ投稿がありません」メッセージ |
| 文字数カウンター動作 | リアルタイム更新 | 入力に応じた文字数表示 |

### 3.2 モバイルテスト（mobile.spec.ts）

| シナリオ | テスト内容 | 検証項目 |
|----------|-----------|----------|
| レスポンシブデザイン | モバイルビュー | ビューポート幅、要素の表示 |
| モバイル投稿作成 | タッチ操作での投稿 | タップ操作、入力、送信 |
| ボタン操作 | 編集・削除ボタン | タップでの操作可能性 |
| 文字数カウンター表示 | モバイルでの見やすさ | カウンターの視認性 |
| スクロール動作 | 長いリストのスクロール | スムーズなスクロール、要素の表示 |

## 4. テスト実行コマンド

### 4.1 単体テスト
```bash
# 単体テスト実行
npm test

# ウォッチモード（ファイル変更時に自動実行）
npm run test:watch

# カバレッジレポート生成
npm run test:coverage
```

### 4.2 E2Eテスト
```bash
# E2Eテスト実行
npm run test:e2e

# UIモード（ブラウザで結果確認）
npm run test:e2e:ui

# デバッグモード
npm run test:e2e:debug
```

### 4.3 全テスト実行
```bash
# 単体テスト + E2Eテスト
npm run test:all
```

## 5. カバレッジ目標

### 5.1 単体テストカバレッジ
| 対象 | 目標 | 現状 |
|------|------|------|
| 全体 | 80% | - |
| コンポーネント | 90% | - |
| API | 85% | - |
| ライブラリ | 75% | - |

### 5.2 E2Eカバレッジ
| シナリオ | カバレッジ |
|----------|-----------|
| CRUD操作 | 100% |
| バリデーション | 100% |
| エラーハンドリング | 80% |
| モバイル対応 | 90% |

## 6. CI/CD統合

### 6.1 GitHub Actions設定例
```yaml
name: Test

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: npm ci
      - run: npm run test:coverage
      - run: npx playwright install --with-deps
      - run: npm run test:e2e
```

### 6.2 実行タイミング
| イベント | 実行テスト |
|----------|-----------|
| コミット | 単体テスト |
| プルリクエスト | 単体テスト + E2Eテスト |
| マージ | 全テスト + カバレッジ |
| リリース | 全テスト + パフォーマンステスト |

## 7. テストデータ

### 7.1 テスト用投稿データ
```javascript
const testPost = {
  _id: 'test-id-001',
  title: 'テスト投稿',
  author: 'テストユーザー',
  content: 'これはテスト用の投稿内容です。',
  createdAt: '2025-01-01T00:00:00.000Z',
  updatedAt: '2025-01-01T00:00:00.000Z'
}
```

### 7.2 境界値テストデータ
| 項目 | 最小値 | 最大値 | 超過値 |
|------|--------|--------|--------|
| タイトル | 1文字 | 100文字 | 101文字 |
| 投稿者名 | 1文字 | 50文字 | 51文字 |
| 内容 | 1文字 | 140文字 | 141文字 |

## 8. トラブルシューティング

### 8.1 よくある問題と解決方法

| 問題 | 原因 | 解決方法 |
|------|------|----------|
| テスト失敗：MongoDB接続 | 環境変数未設定 | .env.localファイル作成 |
| E2Eテストタイムアウト | サーバー起動遅延 | playwright.config.tsのtimeout増加 |
| モックが動作しない | jest.clearAllMocks未実行 | afterEachでクリア実行 |
| Playwright未インストール | ブラウザ未取得 | npx playwright install実行 |

### 8.2 デバッグ方法
```bash
# Jestデバッグ
node --inspect-brk ./node_modules/.bin/jest --runInBand

# Playwrightデバッグ
npm run test:e2e:debug

# 特定テストのみ実行
npm test -- PostForm.test.tsx
npx playwright test board.spec.ts
```

## 9. ベストプラクティス

### 9.1 テスト作成ガイドライン
1. **AAA原則**: Arrange（準備）、Act（実行）、Assert（検証）
2. **独立性**: 各テストは他のテストに依存しない
3. **明確な命名**: テスト名は日本語で具体的に記述
4. **モック活用**: 外部依存はモック化
5. **境界値テスト**: 最小値、最大値、異常値をテスト

### 9.2 保守性向上のコツ
- テストヘルパー関数の作成
- 共通セットアップの抽出
- データビルダーパターンの使用
- ページオブジェクトパターン（E2E）

## 10. 今後の改善計画

### 10.1 短期計画
- [ ] スナップショットテストの追加
- [ ] パフォーマンステストの実装
- [ ] テストカバレッジ80%達成

### 10.2 中期計画
- [ ] ビジュアルリグレッションテスト導入
- [ ] 負荷テストの実装
- [ ] セキュリティテストの追加

### 10.3 長期計画
- [ ] AIを活用したテスト生成
- [ ] カオスエンジニアリング導入
- [ ] 継続的なテスト最適化

## 11. 参考資料

### 11.1 公式ドキュメント
- [Jest公式](https://jestjs.io/)
- [Playwright公式](https://playwright.dev/)
- [Testing Library](https://testing-library.com/)
- [Next.js Testing](https://nextjs.org/docs/testing)

### 11.2 関連ツール
- [Jest VSCode拡張](https://marketplace.visualstudio.com/items?itemName=Orta.vscode-jest)
- [Playwright VSCode拡張](https://marketplace.visualstudio.com/items?itemName=ms-playwright.playwright)

---

作成日: 2025年8月9日
バージョン: 1.0.0