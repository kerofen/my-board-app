# API仕様書

## 1. API概要

### 1.1 基本情報
| 項目 | 内容 |
|------|------|
| ベースURL | http://localhost:3000/api |
| プロトコル | HTTP/HTTPS |
| データ形式 | JSON |
| 文字コード | UTF-8 |
| 認証方式 | なし（現バージョン） |

### 1.2 共通仕様

#### リクエストヘッダー
```http
Content-Type: application/json
```

#### レスポンスヘッダー
```http
Content-Type: application/json
```

#### 共通レスポンス形式
```json
{
  "success": boolean,
  "data": any,
  "error": string (エラー時のみ),
  "mock": boolean (オフラインモード時のみ),
  "warning": string (警告がある場合のみ)
}
```

#### HTTPステータスコード
| コード | 説明 | 使用場面 |
|--------|------|----------|
| 200 | OK | 正常な取得・更新処理 |
| 201 | Created | 新規作成成功 |
| 400 | Bad Request | バリデーションエラー |
| 404 | Not Found | リソースが見つからない |
| 500 | Internal Server Error | サーバーエラー |

## 2. エンドポイント仕様

### 2.1 投稿一覧取得

#### エンドポイント
```
GET /api/posts
```

#### 説明
すべての投稿を作成日時の降順で取得する

#### リクエスト
パラメータなし

#### レスポンス

##### 成功時（200 OK）
```json
{
  "success": true,
  "data": [
    {
      "_id": "507f1f77bcf86cd799439011",
      "title": "投稿タイトル",
      "author": "投稿者名",
      "content": "投稿内容（最大140文字）",
      "createdAt": "2025-08-09T10:30:00.000Z",
      "updatedAt": "2025-08-09T10:30:00.000Z"
    }
  ]
}
```

##### オフラインモード時（200 OK）
```json
{
  "success": true,
  "data": [...],
  "mock": true,
  "warning": "オフラインモードで動作中。データは一時的に保存されます。"
}
```

##### エラー時（500 Internal Server Error）
```json
{
  "success": false,
  "error": "投稿の取得に失敗しました"
}
```

#### 実装詳細
- MongoDBへの接続を試み、失敗時は自動的にモックデータベースにフォールバック
- `sort({ createdAt: -1 })`で最新順にソート
- エラー詳細は開発環境でのみコンソールに出力

### 2.2 投稿作成

#### エンドポイント
```
POST /api/posts
```

#### 説明
新規投稿を作成する

#### リクエスト
```json
{
  "title": "投稿タイトル",
  "author": "投稿者名",
  "content": "投稿内容"
}
```

##### リクエストパラメータ
| パラメータ | 型 | 必須 | 制約 | 説明 |
|-----------|-----|------|------|------|
| title | string | ○ | 最大100文字 | 投稿のタイトル |
| author | string | ○ | 最大50文字 | 投稿者の名前 |
| content | string | ○ | 最大140文字 | 投稿の本文 |

#### レスポンス

##### 成功時（201 Created）
```json
{
  "success": true,
  "data": {
    "_id": "507f1f77bcf86cd799439011",
    "title": "投稿タイトル",
    "author": "投稿者名",
    "content": "投稿内容",
    "createdAt": "2025-08-09T10:30:00.000Z",
    "updatedAt": "2025-08-09T10:30:00.000Z"
  }
}
```

##### バリデーションエラー時（400 Bad Request）
```json
{
  "success": false,
  "error": "タイトルは必須です"
}
```

##### サーバーエラー時（500 Internal Server Error）
```json
{
  "success": false,
  "error": "投稿の作成に失敗しました"
}
```

#### バリデーション
- すべてのフィールドが必須
- 文字数制限はMongooseスキーマで定義
- 空白のみの入力は拒否（クライアント側でtrim()検証）

### 2.3 個別投稿取得

#### エンドポイント
```
GET /api/posts/[id]
```

#### 説明
指定されたIDの投稿を取得する

#### パスパラメータ
| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| id | string | ○ | 投稿のID（MongoDB ObjectIDまたはモックID） |

#### レスポンス

##### 成功時（200 OK）
```json
{
  "success": true,
  "data": {
    "_id": "507f1f77bcf86cd799439011",
    "title": "投稿タイトル",
    "author": "投稿者名",
    "content": "投稿内容",
    "createdAt": "2025-08-09T10:30:00.000Z",
    "updatedAt": "2025-08-09T10:30:00.000Z"
  }
}
```

##### 投稿が見つからない場合（404 Not Found）
```json
{
  "success": false,
  "error": "投稿が見つかりません"
}
```

##### サーバーエラー時（500 Internal Server Error）
```json
{
  "success": false,
  "error": "投稿の取得に失敗しました"
}
```

### 2.4 投稿更新

#### エンドポイント
```
PUT /api/posts/[id]
```

#### 説明
指定されたIDの投稿を更新する

#### パスパラメータ
| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| id | string | ○ | 投稿のID |

#### リクエスト
```json
{
  "title": "更新後のタイトル",
  "author": "更新後の投稿者名",
  "content": "更新後の内容"
}
```

##### リクエストパラメータ
| パラメータ | 型 | 必須 | 制約 | 説明 |
|-----------|-----|------|------|------|
| title | string | ○ | 最大100文字 | 更新後のタイトル |
| author | string | ○ | 最大50文字 | 更新後の投稿者名 |
| content | string | ○ | 最大140文字 | 更新後の本文 |

#### レスポンス

##### 成功時（200 OK）
```json
{
  "success": true,
  "data": {
    "_id": "507f1f77bcf86cd799439011",
    "title": "更新後のタイトル",
    "author": "更新後の投稿者名",
    "content": "更新後の内容",
    "createdAt": "2025-08-09T10:30:00.000Z",
    "updatedAt": "2025-08-09T11:00:00.000Z"
  }
}
```

##### 投稿が見つからない場合（404 Not Found）
```json
{
  "success": false,
  "error": "投稿が見つかりません"
}
```

##### バリデーションエラー時（400 Bad Request）
```json
{
  "success": false,
  "error": "内容は140文字以内で入力してください"
}
```

##### サーバーエラー時（500 Internal Server Error）
```json
{
  "success": false,
  "error": "投稿の更新に失敗しました"
}
```

#### 実装詳細
- `runValidators: true`オプションでスキーマバリデーションを実行
- `new: true`オプションで更新後のドキュメントを返却
- `updatedAt`フィールドは自動更新

### 2.5 投稿削除

#### エンドポイント
```
DELETE /api/posts/[id]
```

#### 説明
指定されたIDの投稿を削除する

#### パスパラメータ
| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| id | string | ○ | 投稿のID |

#### レスポンス

##### 成功時（200 OK）
```json
{
  "success": true,
  "data": null
}
```

##### 投稿が見つからない場合（404 Not Found）
```json
{
  "success": false,
  "error": "投稿が見つかりません"
}
```

##### サーバーエラー時（500 Internal Server Error）
```json
{
  "success": false,
  "error": "投稿の削除に失敗しました"
}
```

## 3. エラーハンドリング

### 3.1 エラーレスポンス形式
すべてのエラーレスポンスは以下の形式に従う：

```json
{
  "success": false,
  "error": "エラーメッセージ（日本語）",
  "details": {} // 開発環境でのみ詳細情報を含む
}
```

### 3.2 エラーメッセージ一覧

| エラーコード | HTTPステータス | メッセージ | 発生条件 |
|-------------|---------------|-----------|----------|
| VALIDATION_ERROR | 400 | タイトルは必須です | タイトル未入力 |
| VALIDATION_ERROR | 400 | 投稿者名は必須です | 投稿者名未入力 |
| VALIDATION_ERROR | 400 | 内容は必須です | 内容未入力 |
| VALIDATION_ERROR | 400 | タイトルは100文字以内で入力してください | タイトル文字数超過 |
| VALIDATION_ERROR | 400 | 投稿者名は50文字以内で入力してください | 投稿者名文字数超過 |
| VALIDATION_ERROR | 400 | 内容は140文字以内で入力してください | 内容文字数超過 |
| NOT_FOUND | 404 | 投稿が見つかりません | 指定IDの投稿が存在しない |
| SERVER_ERROR | 500 | 投稿の取得に失敗しました | データベースエラー |
| SERVER_ERROR | 500 | 投稿の作成に失敗しました | データベースエラー |
| SERVER_ERROR | 500 | 投稿の更新に失敗しました | データベースエラー |
| SERVER_ERROR | 500 | 投稿の削除に失敗しました | データベースエラー |

## 4. オフラインモード仕様

### 4.1 動作概要
MongoDBに接続できない場合、自動的にメモリ内モックデータベースで動作する。

### 4.2 モックデータベースの特徴
| 項目 | 内容 |
|------|------|
| データ永続性 | サーバー再起動で消失 |
| ID生成 | 連番（mock_1, mock_2, ...） |
| タイムスタンプ | JavaScriptのDateオブジェクトで生成 |
| 初期データ | サンプル投稿1件を含む |

### 4.3 オフラインモード判定
レスポンスに`mock: true`フィールドが含まれる場合、オフラインモードで動作中。

```json
{
  "success": true,
  "data": [...],
  "mock": true,
  "warning": "オフラインモードで動作中。データは一時的に保存されます。"
}
```

## 5. パフォーマンス仕様

### 5.1 レスポンスタイム目標
| エンドポイント | 目標時間 | 最大許容時間 |
|---------------|---------|-------------|
| GET /api/posts | 500ms | 3000ms |
| POST /api/posts | 300ms | 2000ms |
| GET /api/posts/[id] | 200ms | 1000ms |
| PUT /api/posts/[id] | 300ms | 2000ms |
| DELETE /api/posts/[id] | 200ms | 1000ms |

### 5.2 同時接続数
- 想定同時接続数: 10ユーザー
- 最大同時接続数: 50ユーザー

## 6. セキュリティ仕様

### 6.1 入力値検証
- すべての入力値はMongooseスキーマで検証
- XSS対策: Reactによる自動エスケープ
- SQLインジェクション対策: MongooseのORM使用

### 6.2 今後の実装予定
- JWT認証の実装
- Rate Limiting（レート制限）
- CORS設定の最適化
- APIキーによるアクセス制御

## 7. バージョニング

### 7.1 現在のバージョン
v1.0.0（初期リリース）

### 7.2 バージョニング方針
将来的にAPIバージョニングを実装する場合：
- URLパス方式: `/api/v2/posts`
- 後方互換性を可能な限り維持

## 8. 使用例

### 8.1 投稿の作成から削除までの流れ

#### 1. 投稿作成
```bash
curl -X POST http://localhost:3000/api/posts \
  -H "Content-Type: application/json" \
  -d '{
    "title": "テスト投稿",
    "author": "テストユーザー",
    "content": "これはテスト投稿です。"
  }'
```

#### 2. 投稿一覧取得
```bash
curl http://localhost:3000/api/posts
```

#### 3. 特定投稿の更新
```bash
curl -X PUT http://localhost:3000/api/posts/507f1f77bcf86cd799439011 \
  -H "Content-Type: application/json" \
  -d '{
    "title": "更新されたタイトル",
    "author": "更新されたユーザー",
    "content": "更新された内容です。"
  }'
```

#### 4. 投稿削除
```bash
curl -X DELETE http://localhost:3000/api/posts/507f1f77bcf86cd799439011
```

## 9. 注意事項

### 9.1 制限事項
- 現在は認証機能なし（誰でも投稿の編集・削除が可能）
- ページネーション未実装（大量データ時にパフォーマンス低下の可能性）
- ファイルアップロード未対応

### 9.2 既知の問題
- オフラインモードのIDは文字列型、MongoDBのIDはObjectID型で型の不一致
- 大量データ取得時のページネーション未実装

### 9.3 推奨事項
- 本番環境ではMONGODB_URI環境変数の設定が必須
- エラーログの適切な監視体制の構築
- 定期的なデータベースバックアップの実施